name: Helm Publish

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  publish-chart:
    permissions:
      contents: write     # ⬅ needed for committing version bump
      packages: write
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # important for committing back

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.19.2

      - name: Build and Push the Helm Charts to GitHub Container Registry
        uses: JimCronqvist/action-helm-chart-repo@master
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          chartsPath: ./charts/

      # ---------------------------------------------------------
      #  Bump Chart Version (patch)
      # ---------------------------------------------------------
      - name: Detect and bump changed Helm chart versions
        run: |
          # find all charts (one folder deep)
          CHARTS=$(find charts -mindepth 1 -maxdepth 1 -type d)

          BUMPED=""

          for CHART in $CHARTS; do
            CHART_FILE="$CHART/Chart.yaml"

            # skip if Chart.yaml does not exist
            [[ ! -f "$CHART_FILE" ]] && continue
            
            # detect whether this chart has changed in this commit
            if ! git diff --name-only HEAD~1 HEAD | grep -q "^$CHART/"; then
              echo "Chart unchanged: $CHART → skipping bump"
              continue
            fi

            echo "Chart changed: $CHART → bumping"

            CURRENT_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}')

            MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
            MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
            PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

            NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"

            sed -i "s/^version:.*/version: $NEW_VERSION/" "$CHART_FILE"

            BUMPED="$BUMPED $(basename $CHART)→$NEW_VERSION"
          done

          if [[ -z "$BUMPED" ]]; then
            echo "No charts changed. Skipping commit."
            echo "SKIP_COMMIT=true" >> $GITHUB_ENV
            exit 0
          fi

          echo "Charts bumped: $BUMPED"
          echo "COMMIT_MESSAGE=ci: bump Helm chart(s): $BUMPED [skip ci]" >> $GITHUB_ENV

      - name: Commit & Push version bump
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: bump Helm chart version to patch $NEW_VERSION"
          branch: main