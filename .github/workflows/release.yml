name: Publish Helm Charts (OCI GHCR)

on:
  push:
    branches:
      - main
    paths:
      - "charts/**"

  workflow_dispatch:
    inputs:
      charts:
        description: "Comma-separated list of charts to force-release (e.g. api,frontend)"
        required: false
        default: ""

permissions:
  packages: write
  contents: write

jobs:
  detect-charts:
    name: Determine Chart List
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if manual input provided
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && \
             [ "${{ github.event.inputs.charts }}" != "" ]; then
            echo "mode=manual" >> $GITHUB_OUTPUT
            echo "charts=${{ github.event.inputs.charts }}" >> $GITHUB_OUTPUT
          else
            echo "mode=auto" >> $GITHUB_OUTPUT
          fi

      - name: Auto-detect changed charts
        id: autodetect
        if: steps.mode.outputs.mode == 'auto'
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD \
            | grep '^charts/' \
            | cut -d/ -f2 \
            | sort -u || true)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Build chart matrix list
        id: set-matrix
        run: |
          arr=()

          if [ "${{ steps.mode.outputs.mode }}" = "manual" ]; then
            for c in $(echo "${{ steps.mode.outputs.charts }}" | tr ',' ' '); do
              if [ -d "charts/$c" ]; then
                arr+=("\"$c\"")
              fi
            done
          else
            for c in ${{ steps.autodetect.outputs.changed }}; do
              if [ -d "charts/$c" ]; then
                arr+=("\"$c\"")
              fi
            done
          fi

          MATRIX="[$(IFS=,; echo "${arr[*]}")]"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  publish:
    name: Publish Charts to GHCR
    needs: detect-charts
    if: needs.detect-charts.outputs.matrix != '[]'
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        chart: ${{ fromJson(needs.detect-charts.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Auto bump version (patch)
        id: bump
        run: |
          CHART="charts/${{ matrix.chart }}/Chart.yaml"

          # Extract version cleanly (raw string)
          RAW=$(yq -r '.version' "$CHART")

          # Remove all non-semver characters (quotes, CRLF, tabs, UTF crap)
          CURRENT=$(printf "%s" "$RAW" | tr -cd '0-9.' | sed 's/^\.*//; s/\.*$//')

          echo "Clean parsed version: '$CURRENT'"

          # Split semver safely in bash (no awk)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          # Ensure numeric values
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          # Increment patch
          PATCH=$((PATCH + 1))

          NEW="$MAJOR.$MINOR.$PATCH"

          echo "Bumping version $CURRENT â†’ $NEW"

          # Write back to Chart.yaml
          yq -i ".version = \"$NEW\"" "$CHART"

          echo "new_version=$NEW" >> $GITHUB_OUTPUT

      - name: Push Helm Chart (OCI GHCR)
        uses: appany/helm-oci-chart-releaser@v0.5.0
        with:
          name: ${{ matrix.chart }}
          repository: ${{ github.repository_owner }}
          tag: ${{ steps.bump.outputs.new_version }}
          path: charts/${{ matrix.chart }}
          registry: ghcr.io
          registry_username: ${{ github.actor }}
          registry_password: ${{ secrets.GITHUB_TOKEN }}
          update_dependencies: 'true'
