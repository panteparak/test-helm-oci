name: Publish Helm Charts (OCI GHCR)

on:
  push:
    branches:
      - main
    paths:
      - "charts/**"

  workflow_dispatch:
    inputs:
      charts:
        description: "Comma-separated list of charts to release (e.g. api,frontend)"
        required: false
        default: ""

permissions:
  packages: write
  contents: write

jobs:
  detect-changes:
    name: Determine Chart List
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # For manual dispatch → Use user input
      - name: Use workflow_dispatch charts if provided
        id: dispatch-input
        run: |
          if [ "${{ github.event.inputs.charts }}" != "" ]; then
            echo "mode=manual" >> $GITHUB_OUTPUT
            echo "charts=${{ github.event.inputs.charts }}" >> $GITHUB_OUTPUT
          else
            echo "mode=auto" >> $GITHUB_OUTPUT
            echo "charts=" >> $GITHUB_OUTPUT
          fi

      # Auto detect changed charts when not manually triggered
      - name: Detect changed charts (auto)
        id: auto-detect
        if: steps.dispatch-input.outputs.mode == 'auto'
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD \
            | grep '^charts/' \
            | cut -d/ -f2 \
            | sort -u || true)

          echo "auto=$CHANGED" >> $GITHUB_OUTPUT

      - name: Merge manual or auto charts into matrix array
        id: set-matrix
        run: |
          arr=()

          if [ "${{ steps.dispatch-input.outputs.mode }}" = "manual" ]; then
            echo "Using manual chart list..."
            for c in $(echo "${{ steps.dispatch-input.outputs.charts }}" | tr ',' ' '); do
              if [ -d "charts/$c" ]; then
                arr+=("\"$c\"")
              fi
            done
          else
            echo "Using auto-detected charts..."
            for c in ${{ steps.auto-detect.outputs.auto }}; do
              if [ -d "charts/$c" ]; then
                arr+=("\"$c\"")
              fi
            done
          fi

          MATRIX="[$(IFS=,; echo "${arr[*]}")]"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Print matrix
        run: echo "${{ steps.set-matrix.outputs.matrix }}"

  publish:
    name: Publish Charts to GHCR
    needs: detect-changes
    if: needs.detect-changes.outputs.matrix != '[]'
    runs-on: ubuntu-latest

    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Auto bump version (patch)
        run: |
          CHART_PATH="charts/${{ matrix.chart }}/Chart.yaml"
          CURRENT=$(yq '.version' "$CHART_PATH")
          NEW=$(echo "$CURRENT" | awk -F. '{$NF = $NF + 1; OFS="."; print}')
          echo "Bumping $CURRENT → $NEW for ${{ matrix.chart }}"
          yq -i ".version = \"$NEW\"" "$CHART_PATH"

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io \
            --username "${{ github.actor }}" \
            --password-stdin

      - name: Publish Helm Chart
        uses: appany/helm-oci-chart-releaser@v0.5.0
        with:
          name: ${{ matrix.chart }}
          path: charts/${{ matrix.chart }}
          repository: ${{ github.repository_owner }}
          registry: ghcr.io
          token: ${{ secrets.GITHUB_TOKEN }}
